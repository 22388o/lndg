{% extends "base.html" %}
{% block content %}
{% load humanize %}
<div class="w3-container w3-padding-small">
  <h3><a href="https://1ml.com/node/{{ node_info.identity_pubkey }}" target="_blank">{{ node_info.alias }}</a> | {{ node_info.identity_pubkey }}</h3>
  <h4>Active Channels: {{ node_info.num_active_channels }} | {% for info in node_info.chains %}{{ info }}{% endfor %} | {{ node_info.block_height }} | {{ node_info.block_hash }}</h4>
  <h4>Public Address: {% for info in node_info.uris %}{{ info }}{% endfor %}</h4>
</div>
<div class="w3-container w3-padding-small">
  <h4>Total Wallet Balance: {{ balances.total_balance|intcomma }}</h4>
  <h4>Confirmed Wallet Balance: {{ balances.confirmed_balance|intcomma }}</h4>
  <h4>Unconfirmed Wallet Balance: {{ balances.unconfirmed_balance|intcomma }}</h4>
</div>
<div class="w3-container">
  <form action="/newaddress/" method="post">
    {% csrf_token %}
    <input type="submit" value="Get New Deposit Address">
  </form>
</div>
<div class="w3-container w3-padding-small">
  <h4>Total Completed Payments: {{ total_payments }}</h4>
  <h4>Total Sats Sent: {{ total_sent|intcomma }}</h4>
  <h4>Total Fees Paid: {{ fees_paid|intcomma }}</h4>
</div>
<div class="w3-container w3-padding-small">
  <h4>Total Paid Invoices: {{ total_invoices }}</h4>
  <h4>Total Sats Received: {{ total_received|intcomma }}</h4>
</div>
<div class="w3-container w3-padding-small">
  <h4>Total Payments Routed: {{ total_forwards }}</h4>
  <h4>Total Value Routed: {{ total_value_forwards|intcomma }}</h4>
  <h4>Total Fees Earned: {{ earned|intcomma }}</h4>
</div>
<div class="w3-container w3-padding-small">
  <h4>Total Node Capacity: {{ capacity|intcomma }}</h4>
  <h4>Total Inbound Liquidity: {{ inbound|intcomma }}</h4>
  <h4>Total Outbound Liquidity: {{ outbound|intcomma }}</h4>
  <h4>Total Unsettled Liquidity: {{ unsettled|intcomma }}</h4>
  <h4>Total Balance In Limbo: {{ limbo_balance|intcomma }}</h4>
</div>
{% if active_channels %}
<div class="w3-container w3-padding-small">
  <h2>Active Channels</h2>
  <table class="w3-table-all w3-centered w3-hoverable">
    <tr>
      <th width=15%>Channel Point</th>
      <th>Channel ID</th>
      <th>Channel Alias</th>
      <th>Capacity</th>
      <th>Outbound Liquidity</th>
      <th width=10%></th>
      <th>Inbound Liquidity</th>
      <th>Initiated By Me</th>
      <th>Base Fee</th>
      <th>Fee Rate</th>
      <th>Routed In</th>
      <th>Routed Out</th>
      <th>Rebalance?</th>
    </tr>
    {% for channel in active_channels %}
    <tr>
      <td><a href="https://www.blockchain.com/btc/tx/{{ channel.funding_txid }}" target="_blank">{{ channel.funding_txid }}:{{ channel.output_index }}</a></td>
      <td>{{ channel.chan_id }}</td>
      <td><a href="https://1ml.com/node/{{ channel.remote_pubkey }}" target="_blank">{{ channel.alias }}</a></td>
      <td>{{ channel.capacity|intcomma }}</td>
      <td>{{ channel.local_balance|intcomma }}</td>
      <td><div class="w3-orange w3-round">{% if channel.visual == 0 %}<div class="w3-container w3-round w3-orange" style="height:16px;width:{% widthratio channel.visual 1 100 %}%"></div>{% else %}<div class="w3-container w3-round w3-blue" style="height:16px;width:{% widthratio channel.visual 1 100 %}%"></div>{% endif %}</div></td>
      <td>{{ channel.remote_balance|intcomma }}</td>
      <td>{{ channel.initiator }}</td>
      <td>{{ channel.base_fee }}</td>
      <td>{{ channel.fee_rate }}</td>
      <td>{{ channel.amt_routed_in|intcomma }} ({{ channel.routed_in }})</td>
      <td>{{ channel.amt_routed_out|intcomma }} ({{ channel.routed_out }})</td>
      <td>{{ channel.auto_rebalance }}</td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endif %}
{% if inactive_channels %}
<div class="w3-container w3-padding-small">
  <h2>Inactive Channels</h2>
  <table class="w3-table-all w3-centered w3-hoverable">
    <tr>
      <th width=20%>Channel Point</th>
      <th>Channel ID</th>
      <th>Channel Alias</th>
      <th>Capacity</th>
      <th>Local Balance</th>
      <th>Remote Balance</th>
      <th>Initiated By Me</th>
      <th>Base Fee</th>
      <th>Fee Rate</th>
    </tr>
    {% for channel in inactive_channels %}
    <tr>
      <td><a href="https://www.blockchain.com/btc/tx/{{ channel.funding_txid }}" target="_blank">{{ channel.funding_txid }}:{{ channel.output_index }}</a></td>
      <td>{{ channel.chan_id }}</td>
      <td><a href="https://1ml.com/node/{{ channel.remote_pubkey }}" target="_blank">{{ channel.alias }}</a></td>
      <td>{{ channel.capacity|intcomma }}</td>
      <td>{{ channel.local_balance|intcomma }}</td>
      <td>{{ channel.remote_balance|intcomma }}</td>
      <td>{{ channel.initiator }}</td>
      <td>{{ channel.base_fee }}</td>
      <td>{{ channel.fee_rate }}</td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endif %}
{% if pending_open %}
<div class="w3-container w3-padding-small">
  <h2>Pending Open Channels</h2>
  <table class="w3-table-all w3-centered w3-hoverable">
    <tr>
      <th width=30%>Channel Point</th>
      <th width=30%>Peer PubKey</th>
      <th>Capacity</th>
      <th>Local Balance</th>
      <th>Remote Balance</th>
      <th>Commit Fee</th>
    </tr>
    {% for channel in pending_open %}
    <tr>
      {% with pending_funding_txid=channel.channel.channel_point|slice:":-2" %}
        <td><a href='https://www.blockchain.com/btc/tx/{{ pending_funding_txid }}' target="_blank">{{ channel.channel.channel_point }}</a></td>
      {% endwith %}
      <td><a href="https://1ml.com/node/{{ channel.channel.remote_node_pub }}" target="_blank">{{ channel.channel.remote_node_pub }}</a></td>
      <td>{{ channel.channel.capacity|intcomma }}</td>
      <td>{{ channel.channel.local_balance|intcomma }}</td>
      <td>{{ channel.channel.remote_balance|intcomma }}</td>
      <td>{{ channel.commit_fee }}</td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endif %}
{% if pending_closed %}
<div class="w3-container w3-padding-small">
  <h2>Pending Close Channels</h2>
  <table class="w3-table-all w3-centered w3-hoverable">
    <tr>
      <th width=30%>Channel Point</th>
      <th width=30%>Peer PubKey</th>
      <th>Capacity</th>
      <th>Local Balance</th>
      <th>Remote Balance</th>
      <th>Commit Fee</th>
    </tr>
    {% for channel in pending_closed %}
    <tr>
      {% with pending_funding_txid=channel.channel.channel_point|slice:":-2" %}
        <td><a href='https://www.blockchain.com/btc/tx/{{ pending_funding_txid }}' target="_blank">{{ channel.channel.channel_point }}</a></td>
      {% endwith %}
      <td><a href="https://1ml.com/node/{{ channel.channel.remote_node_pub }}" target="_blank">{{ channel.channel.remote_node_pub }}</a></td>
      <td>{{ channel.channel.capacity|intcomma }}</td>
      <td>{{ channel.channel.local_balance|intcomma }}</td>
      <td>{{ channel.channel.remote_balance|intcomma }}</td>
      <td>{{ channel.commit_fee }}</td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endif %}
{% if pending_force_closed %}
<div class="w3-container w3-padding-small">
  <h2>Pending Force Close Channels</h2>
  <table class="w3-table-all w3-centered w3-hoverable">
    <tr>
      <th width=30%>Channel Point</th>
      <th width=30%>Peer PubKey</th>
      <th>Capacity</th>
      <th>Local Balance</th>
      <th>Remote Balance</th>
      <th>Commit Fee</th>
    </tr>
    {% for channel in pending_force_closed %}
    <tr>
      {% with pending_funding_txid=channel.channel.channel_point|slice:":-2" %}
        <td><a href='https://www.blockchain.com/btc/tx/{{ pending_funding_txid }}' target="_blank">{{ channel.channel.channel_point }}</a></td>
      {% endwith %}
      <td><a href="https://1ml.com/node/{{ channel.channel.remote_node_pub }}" target="_blank">{{ channel.channel.remote_node_pub }}</a></td>
      <td>{{ channel.channel.capacity|intcomma }}</td>
      <td>{{ channel.channel.local_balance|intcomma }}</td>
      <td>{{ channel.channel.remote_balance|intcomma }}</td>
      <td>{{ channel.commit_fee }}</td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endif %}
{% if waiting_for_close %}
<div class="w3-container w3-padding-small">
  <h2>Channels Waiting To Close</h2>
  <table class="w3-table-all w3-centered w3-hoverable">
    <tr>
      <th width=30%>Channel Point</th>
      <th width=30%>Peer PubKey</th>
      <th>Capacity</th>
      <th>Local Balance</th>
      <th>Remote Balance</th>
      <th>Commit Fee</th>
    </tr>
    {% for channel in waiting_for_close %}
    <tr>
      {% with pending_funding_txid=channel.channel.channel_point|slice:":-2" %}
        <td><a href='https://www.blockchain.com/btc/tx/{{ pending_funding_txid }}' target="_blank">{{ channel.channel.channel_point }}</a></td>
      {% endwith %}
      <td><a href="https://1ml.com/node/{{ channel.channel.remote_node_pub }}" target="_blank">{{ channel.channel.remote_node_pub }}</a></td>
      <td>{{ channel.channel.capacity|intcomma }}</td>
      <td>{{ channel.channel.local_balance|intcomma }}</td>
      <td>{{ channel.channel.remote_balance|intcomma }}</td>
      <td>{{ channel.commit_fee }}</td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endif %}
{% if peers %}
<div class="w3-container w3-padding-small">
  <h2>Peers List</h2>
  <table class="w3-table-all w3-centered w3-hoverable">
    <tr>
      <th width=40%>Peer PubKey</th>
      <th>Network Address</th>
      <th>Inbound</th>
      <th>Sats Sent</th>
      <th>Sats Received</th>
    </tr>
    {% for peer in peers %}
    <tr>
      <td><a href="https://1ml.com/node/{{ peer.pub_key }}" target="_blank">{{ peer.pub_key }}</a></td>
      <td>{{ peer.address }}</td>
      <td>{{ peer.inbound }}</td>
      <td>{{ peer.sat_sent|intcomma }}</td>
      <td>{{ peer.sat_recv|intcomma }}</td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endif %}
{% if forwards %}
<div class="w3-container w3-padding-small">
  <h2>Last 10 Payments Routed</h2>
  <table class="w3-table-all w3-centered w3-hoverable">
    <tr>
      <th>Timestamp</th>
      <th>Amount In</th>
      <th>Amount Out</th>
      <th>Channel In Alias</th>
      <th>Channel Out Alias</th>
      <th>Channel In Id</th>
      <th>Channel Out Id</th>
      <th>Fees Earned</th>
    </tr>
    {% for forward in forwards %}
    <tr>
      <td>{{ forward.forward_date|naturaltime }}</td>
      <td>{% widthratio forward.amt_in_msat 1000 1 %}</td>
      <td>{% widthratio forward.amt_out_msat 1000 1 %}</td>
      <td>{{ forward.chan_in_alias }}</td>
      <td>{{ forward.chan_out_alias }}</td>
      <td>{{ forward.chan_id_in }}</td>
      <td>{{ forward.chan_id_out }}</td>
      <td>{{ forward.fee }}</td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endif %}
{% if payments %}
<div class="w3-container w3-padding-small">
  <h2>Last 5 Payments Sent</h2>
  <table class="w3-table-all w3-centered w3-hoverable">
    <tr>
      <th>Timestamp</th>
      <th width=30%>Hash</th>
      <th>Value</th>
      <th>Fee Paid</th>
      <th>Status</th>
      <th>Route</th>
    </tr>
    {% for payment in payments %}
    <tr>
      <td>{{ payment.creation_date|naturaltime }}</td>
      <td>{{ payment.payment_hash }}</td>
      <td>{{ payment.value|add:"0" }}</td>
      <td>{{ payment.fee }}</td>
      <td>{% if payment.status == 1 %}In-Flight{% elif payment.status == 2 %}Succeeded{% elif payment.status == 3 %}Failed{% else %}{{ payment.status }}{% endif %}</td>
      <td>{% if payment.status == 2 %}<a href="/route?={{ payment.payment_hash }}" target="_blank">Open</a>{% else %}N/A{% endif %}</td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endif %}
{% if invoices %}
<div class="w3-container w3-padding-small">
  <h2>Last 5 Payments Received</h2>
  <table class="w3-table-all w3-centered w3-hoverable">
    <tr>
      <th>Created</th>
      <th>Settled</th>
      <th width=25%>Payment Hash</th>
      <th>Value</th>
      <th>Amount Paid</th>
      <th>State</th>
    </tr>
    {% for invoice in invoices %}
    <tr>
      <td>{{ invoice.creation_date|naturaltime }}</td>
      <td>{% if invoice.state == 1 %}{{ invoice.settle_date|naturaltime }}{% else %}N/A{% endif %}</td>
      <td>{{ invoice.r_hash }}</td>
      <td>{{ invoice.value|add:"0" }}</td>
      <td>{% if invoice.state == 1 %}{{ invoice.amt_paid|intcomma }}{% else %}N/A{% endif %}</td>
      <td>{% if invoice.state == 0 %}Open{% elif invoice.state == 1 %}Settled{% elif invoice.state == 2 %}Canceled{% else %}{{ invoice.state }}{% endif %}</td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endif %}
{% if rebalances %}
<div class="w3-container w3-padding-small">
  <h2>Last 5 Rebalance Requests</h2>
  <table class="w3-table-all w3-centered w3-hoverable">
    <tr>
      <th>Requested</th>
      <th>Start</th>
      <th>Stop</th>
      <th>Scheduled Duration</th>
      <th>Value</th>
      <th>Fee Limit</th>
      <th>Last Hop PubKey</th>
      <th>Status</th>
    </tr>
    {% for rebalance in rebalances %}
    <tr>
      <td>{{ rebalance.requested|naturaltime }}</td>
      <td>{% if rebalance.status == 0 %}N/A{% else %}{{ rebalance.start|naturaltime }}{% endif %}</td>
      <td>{% if rebalance.status > 1 %}{{ rebalance.stop|naturaltime }}{% else %}N/A{% endif %}</td>
      <td>{{ rebalance.duration }} minutes</td>
      <td>{{ rebalance.value }}</td>
      <td>{{ rebalance.fee_limit }}</td>
      <td width=25%>{% if rebalance.last_hop_pubkey == '' %}None Specified{% else %}{{ rebalance.last_hop_pubkey }}{% endif %}</td>
      <td>{% if rebalance.status == 0 %}Pending{% elif rebalance.status == 1 %}In-Flight{% elif rebalance.status == 2 %}Successful{% elif rebalance.status == 3 %}Timeout{% elif rebalance.status == 4 %}No Route{% elif rebalance.status == 5 %}Error{% elif rebalance.status == 6 %}Incorrect Payment Details{% elif rebalance.status == 7 %}Insufficient Balance{% elif rebalance.status == 400 %}Rebalancer Request Failed{% else %}{{ rebalance.status }}{% endif %}</td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endif %}
<div class="w3-container w3-padding-small">
  <h2>Connect To A Peer</h2>
  <div class="w3-container w3-padding-32">
    <form action="/connectpeer/" method="post">
      {% csrf_token %}
      <label for="peer_pubkey">Peer PubKey: </label>
      <input id="peer_pubkey" type="text" name="peer_pubkey">
      <label for="host">Host IP/Onion: </label>
      <input id="host" type="text" name="host">
      <input type="submit" value="OK">
    </form>
  </div>
</div>
<div class="w3-container w3-padding-small">
  <h2>Open A Channel</h2>
  <div class="w3-container w3-padding-32">
    <form action="/openchannel/" method="post">
      {% csrf_token %}
      <label for="peer_pubkey">Peer Pubkey: </label>
      <input id="peer_pubkey" type="text" name="peer_pubkey">
      <label for="local_amt">Local Amount: </label>
      <input id="local_amt" type="number" name="local_amt">
      <label for="sat_per_byte">Target Fee (sats/byte): </label>
      <input id="sat_per_byte" type="number" name="sat_per_byte">
      <input type="submit" value="OK">
    </form>
  </div>
</div>
<div class="w3-container w3-padding-small">
  <h2>Close A Channel</h2>
  <div class="w3-container w3-padding-32">
    <form action="/closechannel/" method="post">
      {% csrf_token %}
      <label for="funding_txid">Funding TXID: </label>
      <input id="funding_txid" type="text" name="funding_txid">
      <label for="output_index">Output Index: </label>
      <input id="output_index" type="number" name="output_index">
      <label for="force">Force Close? </label>
      <input id="force" type="checkbox" name="force">
      <input type="submit" value="OK">
    </form>
  </div>
</div>
<div class="w3-container w3-padding-small">
  <h2>Create Invoice</h2>
  <div class="w3-container w3-padding-32">
    <form action="/createinvoice/" method="post">
      {% csrf_token %}
      <label for="value">Invoice Amount: </label>
      <input id="value" type="number" name="value">
      <input type="submit" value="OK">
    </form>
  </div>
</div>
<div class="w3-container w3-padding-small">
  <h2>Rebalancer</h2>
  <div class="w3-container w3-padding-32">
    <form action="/rebalancer/" method="post">
      {% csrf_token %}
      <label for="duration">Run Time (min): </label>
      <input id="duration" type="number" name="duration">
      <label for="value">Rebalance Amount: </label>
      <input id="value" type="number" name="value">
      <label for="fee_limit">Fee Limit: </label>
      <input id="fee_limit" type="number" name="fee_limit">
      <label for="last_hop_pubkey">Last Hop Pubkey: </label>
      <input id="last_hop_pubkey" type="text" name="last_hop_pubkey">
      <input type="submit" value="OK">
      <ul class="w3-ul w3-border" style="width:56.15%">
        <li><h3><label for="outgoing_chan_ids">Select Outgoing Channel IDs: </label></h3></li>
        {% for channel in rebalancer_form.outgoing_chan_ids %}
          <li>{{ channel }}</li>
        {% endfor %}
      </ul>
    </form>
  </div>
</div>
<div class="w3-container w3-padding-small">
  <h2>Update Channel Policy</h2>
  <div class="w3-container w3-padding-32">
    <form action="/updatechanpolicy/" method="post">
      {% csrf_token %}
      <label for="new_base_fee">New Base Fee: </label>
      <input id="new_base_fee" type="number" name="new_base_fee">
      <label for="new_fee_rate">New Fee Rate: </label>
      <input id="new_fee_rate" type="number" name="new_fee_rate">
      <label for="target_all">Target All Channels? </label>
      <input id="target_all" type="checkbox" name="target_all">
      <input type="submit" value="OK">
      <ul class="w3-ul w3-border" style="width:35.2%">
        <li><h3><label for="target_chans">Select Channels To Update: </label></h3></li>
        {% for channel in chan_policy_form.target_chans %}
          <li>{{ channel }}</li>
        {% endfor %}
      </ul>
    </form>
  </div>
</div>
<div class="w3-container w3-padding-small">
  <h2>Toggle Channel Auto Rebalance Status</h2>
  <div class="w3-container w3-padding-32">
    <form action="/autorebalance/" method="post">
      {% csrf_token %}
      <label for="chan_id">Channel ID: </label>
      <input id="chan_id" type="number" name="chan_id">
      <input type="submit" value="OK">
    </form>
  </div>
</div>
{% endblock %}